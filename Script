#### 0. Librerías ####
library(dplyr)
library(tidyr)
library(lubridate)
library(unmarked)
library(DataExplorer)
library(ggplot2)
#### 1, Parámetros para el modelo ####
especie_objetivo <- "Tetrax tetrax"
año_objetivo     <- 2023
n_visitas_max    <- 4
K_limit          <- 1000 #Alto para manejar correctamente bandos grandes

#### 2. Carga y limpieza de datos ####
Contactos <- read.csv("ContactosConCuadriculas.csv")

aves_limpio <- Contactos %>%
  mutate(
    fecha = as.Date(OBSERVAT_1),
    mes = month(fecha),
    ID_lista_final = ifelse(!is.na(GROUP.IDEN) & GROUP.IDEN != "", GROUP.IDEN, SAMPLING.E), #Gestión de datos duplicados por grupos de observadores
    conteo_num = ifelse(OBSERVATIO == "X", 1, as.numeric(OBSERVATIO)) #Nueva columna con el recuento de individuos, en formato numérico
  ) %>%
  filter(year(fecha) == año_objetivo) %>%
  filter(mes %in% c(3,4,5)) %>% #Filtro para los meses de reproducción de la especie
  distinct(ID_lista_final, SCIENTIFIC, .keep_all = TRUE) #Mantener una única ID_lista por especie diferente

#Información del dataset inicial y los filtrados
cat("Registros totales en el archivo original:", nrow(Contactos), "\n")
cat("Cuadrículas totales en el archivo original:", n_distinct(Contactos$id_cuadric), "\n")
cat("Registros tras filtrar por año (", año_objetivo, ") y limpiar duplicados:", nrow(aves_limpio), "\n")
cat("Cuadrículas únicas restantes:", n_distinct(aves_limpio$id_cuadric), "\n")
cat("Individuos totales (todas las especies):", sum(aves_limpio$conteo_num), "\n")
cat("Individuos totales de", especie_objetivo, sum(aves_limpio$conteo_num[aves_limpio$SCIENTIFIC == especie_objetivo]), "\n")

#### 3. Estructura de visitas ####
visitas_all_raw <- aves_limpio %>%
  group_by(id_cuadric, fecha) %>% #Agrupación por cuadrícula y fecha
  summarise( #Guardar variables de muestreo
    duracion = max(DURATION.M, na.rm = TRUE),
    observadores = max(NUMBER.OBS, na.rm = TRUE),
    protocolo = first(PROTOCOL.N),
    hora = first(TIME.OBSER),
    .groups = "drop"
  ) %>% 
  mutate( #Gestión de errores en los valores de duración
    duracion = ifelse(is.infinite(duracion) | is.na(duracion), mean(duracion[!is.infinite(duracion)], na.rm=TRUE), duracion)
  )
# Cuenta de los individuos registrados por cuadrícula y fecha
contajes_especie <- aves_limpio %>%
  filter(SCIENTIFIC == especie_objetivo) %>%
  group_by(id_cuadric, fecha) %>%
  summarise(count = sum(conteo_num, na.rm = TRUE), .groups = "drop")

visitas_final_filtrado <- visitas_all_raw %>%
  left_join(contajes_especie, by = c("id_cuadric", "fecha")) %>%
  mutate(count = replace_na(count, 0)) %>% 
  group_by(id_cuadric) %>%
  arrange(fecha) %>%
  mutate(visita_id = row_number(), n_visitas_totales = n()) %>%
  ungroup() %>%
  filter(n_visitas_totales >= 3 & visita_id <= n_visitas_max) #Filtro de visitas
#Comprobaciones
cat("Visitas totales antes de filtrar:", nrow(visitas_all_raw), "\n")
cat("Cuadrículas que cumplen el requisito (>= 3 visitas):", n_distinct(visitas_final_filtrado$id_cuadric), "\n")
cat("INdividuos de", especie_objetivo, "que quedan tras el filtro de esfuerzo:", sum(visitas_final_filtrado$count), "\n")

#### 4. Preparación del dataframe para unmarked ####
##### 4.1. Matriz Y #####
y_matrix <- visitas_final_filtrado %>%
  select(id_cuadric, visita_id, count) %>%
  pivot_wider(names_from = visita_id, values_from = count, names_prefix = "visit_") %>%
  arrange(id_cuadric)

matriz_y_limpia <- as.matrix(y_matrix %>% select(starts_with("visit_")))

#Comprobaciones de los datos de la matriz
summary(as.vector(matriz_y_limpia))
cat("El valor máximo en la matriz es:", max(matriz_y_limpia, na.rm=TRUE), "\n")
cuadriculas_extremas <- which(matriz_y_limpia > 100, arr.ind = TRUE)
print(cuadriculas_extremas)
proporcion_ceros <- sum(matriz_y_limpia == 0, na.rm=TRUE) / length(matriz_y_limpia)
cat("Proporción de ceros:", round(proporcion_ceros, 2), "\n")
##### 4.2. Covaraibles de observación (muestreo) #####
obs_covs_wide <- visitas_final_filtrado %>%
  mutate(
    hora_num = as.numeric(substr(hora, 1, 2)) * 60 + as.numeric(substr(hora, 4, 5)), # Extraer hora y minuto y conversión a total minutos
    fecha_num = yday(fecha), # Día del año (1-365)
    protocolo_n = as.numeric(as.factor(protocolo)) # Protocolo a factor numérico
  ) %>%
  select(id_cuadric, visita_id, duracion, observadores, hora_num, fecha_num, protocolo_n) %>%
  pivot_wider(names_from = visita_id, values_from = 3:7, names_glue = "{.value}_v{visita_id}") %>%
  arrange(id_cuadric)
#Lista de covariables
obs_list <- list(
  duracion = scale(as.matrix(obs_covs_wide %>% select(starts_with("duracion_")))),
  obs_n = scale(as.matrix(obs_covs_wide %>% select(starts_with("observadores_")))),
  hora = scale(as.matrix(obs_covs_wide %>% select(starts_with("hora_num_")))),
  fecha = scale(as.matrix(obs_covs_wide %>% select(starts_with("fecha_num_")))),
  protocolo = as.matrix(obs_covs_wide %>% select(starts_with("protocolo_")))
)
##### 4.3. Covariables de hábitat (sitio) #####
DistanciasRN <- read.csv("DistanciaRN.csv")
DistanciasCarreteras <- read.csv("DistanciaCarreteras.csv")
CuadriculasSIOSE <- read.csv("CuadriculasSIOSE.csv")
#Extracción de la provincia
referencia_provincias <- aves_limpio %>%
  select(id_cuadric, provincia = COUNTY) %>% #Cambio de nombre de COUNTY a "provincia"
  distinct(id_cuadric, .keep_all = TRUE)
# Agrupar SIOSE
habitat_grouped <- CuadriculasSIOSE %>%
  group_by(id_cuadric, CODIIGE) %>%
  summarise(Porcentaje = sum(porcentaje, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = CODIIGE, values_from = Porcentaje, names_prefix = "P_") %>%
  mutate(across(starts_with("P_"), ~replace_na(., 0)))
# Unión de datasets
site_covs_inicial <- habitat_grouped %>%
  left_join(DistanciasCarreteras, by = "id_cuadric") %>%
  rename(distance_carretera = distance) %>%
  left_join(DistanciasRN %>% group_by(id_cuadric) %>% summarise(dist_rn = min(distance)), by = "id_cuadric") %>%
  left_join(referencia_provincias, by = "id_cuadric") %>% # Unión de la provincia extraída
  filter(id_cuadric %in% y_matrix$id_cuadric) %>%
  arrange(id_cuadric)
# Escalado de datos y selección de variables de interes
variables_interes <- c("P_210", "P_260", "P_320", "distance_carretera", "dist_rn")

site_covs_final <- site_covs_inicial %>%
  mutate(provincia = as.factor(provincia)) %>%
  mutate(across(all_of(variables_interes), scale)) %>%
  select(id_cuadric, provincia, all_of(variables_interes))

#### 5. Análisis exploratorio #####
#Análisis del dataset inicial
create_report(Contactos, output_file="EDA_Datos_Originales.html")
#Análisis de las variables de hábitat
create_report(site_covs_inicial, output_file="EDA_site_covs.html")
create_report(site_covs_final, output_file="EDA_site_covs_final.html")
#Análisis de las variables de observación
create_report(obs_covs_wide, output_file="EDA_obs_covs_wide.html")

#### 6. Modelo unmarked ####
umf <- unmarkedFramePCount(
  y = matriz_y_limpia,
  siteCovs = site_covs_final %>% select(-id_cuadric),
  obsCovs = obs_list
)
modelo <- pcount(~ duracion + protocolo + obs_n + hora + fecha
                 ~ P_210 + P_260 + P_320 + distance_carretera + dist_rn, 
                 data = umf, K = K_limit, mixture ="NB")
summary(modelo)

#### 7. Validación del modelo ####
fitstats <- function(m) {
  f <- fitted(m) #Valores esperados
  y <- getY(m) #Valores observados
  chisq <- sum((y - f)^2 / (f + 0.5), na.rm=TRUE)
  return(c(chisq=chisq))
}
pb_modelo <- parboot(modelo, statistic=fitstats, nsim=50)
print(pb_modelo)

#Resultados y abundancia estimada
abundancia_estimada <- bup(ranef(modelo), stat="mean")
resultados_abundancia <- data.frame(
  id_cuadric = site_covs_final$id_cuadric,
  provincia  = site_covs_final$provincia,
  Max_Obs    = apply(matriz_y_limpia, 1, max, na.rm=TRUE),
  Estimado   = round(abundancia_estimada, 2)
)

resultados_abundancia <- resultados_abundancia %>% 
  arrange(desc(Estimado))
head(resultados_abundancia, 10)
# Ver la suma total de individuos estimados en las 30 cuadrículas
total_estimado <- sum(abundancia_estimada)
cat("El modelo estima un total de", round(total_estimado), "individuos en la zona de estudio.\n")

# Comparar con el conteo máximo observado
total_observado <- sum(apply(y_matrix %>% select(starts_with("visit_")), 1, max, na.rm=TRUE))
cat("El conteo máximo observado fue de", total_observado, "individuos.\n")
ggplot(resultados_abundancia, aes(x = Max_Obs, y = Estimado)) +
  geom_point(color = "darkgreen", alpha = 0.6) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(title = "Abundancia Observada vs. Estimada por Cuadrícula",
       x = "Máximo de individuos observados",
       y = "Individuos estimados (N-mixture)") +
  theme_minimal()



#### 8. Guardado ####
saveRDS(modelo, file = paste0("modelo_", gsub(" ", "_", especie_objetivo), ".rds"))
